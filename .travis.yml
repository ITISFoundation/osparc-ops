dist: xenial
env:
  global:
    - DOCKER_COMPOSE_VERSION=1.23.2
services:
  - docker
addons:
  apt:
    packages:
      - docker-ce
      - expect-dev # for unbuffer: brings color back into travis logs
jobs:
  include:
    - stage: unit testing
      name: deployment-agent
      language: python
      python:
        - "3.6"
        - "3.7"
      cache: pip
      before_install:
        - sudo bash ops/travis/unit-testing/deployment-agent before_install
      install:
        - unbuffer bash ops/travis/unit-testing/deployment-agent install
      before_script:
        - unbuffer bash ops/travis/unit-testing/deployment-agent before_script
      script:
        - unbuffer bash ops/travis/unit-testing/deployment-agent script
      after_success:
        - unbuffer bash ops/travis/unit-testing/deployment-agent after_success

    - stage: system testing, staging
      name: deployment-agent
      language: python
      python:
        - "3.6"
        - "3.7"
      before_install:
        - sudo bash ops/travis/system-testing/deployment-agent before_install
      install:
        - unbuffer bash ops/travis/system-testing/deployment-agent install
      before_script:
        - unbuffer bash ops/travis/system-testing/deployment-agent before_script
      script:
        - unbuffer bash ops/travis/system-testing/deployment-agent script
      after_success:
        - unbuffer bash ops/travis/system-testing/deployment-agent after_success
      after_failure:
        - unbuffer bash ops/travis/system-testing/deployment-agent after_failure
      deploy:
        - provider: script
          skip_cleanup: true
          script: unbuffer bash ops/travis/deploy/deployment-agent deploy-staging
          on:
            branch: master
